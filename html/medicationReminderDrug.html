<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>添加用药</title>
  <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css"/>
  <link rel="stylesheet" type="text/css" href="../lib/css/jquery-weui.css"/>
  <link rel="stylesheet" type="text/css" href="../custom/css/common.css"/>
  <link rel="stylesheet" type="text/css" href="../custom/css/medicationReminder.css"/>

</head>

<body>
<div class="MedicationReminder">
  <div class="scroll-wrap">
    <div class="tabWrap">
      <span class="current">口服药</span><span>胰岛素</span>
    </div>
    <div class="mainCon" style="padding-top: 1.4rem;">
      <ul class="listAdd">
        <li>
          <span class="name">药品名称</span>
          <div class="r" style="width:70%;text-align:right;">
            <div class="mySelectDrug" id="selectDrug">
              <input type="hidden" name="drug-name" id="drug-name" value="" data-id="0" data-drug-name="">
              <input type="hidden" name="drug-dose" id="drug-dose" value="" data-drug-dose="">
              <span data-drug-name="" data-drug-dose="" id="showDrug" class="max-hei">选择用药</span>
            </div>
            <span class="arrow-r"></span>
          </div>
        </li>
        <li>
          <span class="name">服用剂量</span>
          <span class="r"><input type="text" placeholder="数量" class="itext" onkeyup="takeDose(this)"/><span class="unit">片</span></span>
        </li>
      </ul>
      <h3 class="mTitle">用药时间</h3>
      <ul class="listDrugTime">
        <!--<li>-->
          <!--<img src='../custom/images/drug_clock.png' class="icoClock"/>-->
          <!--<span class="time">09:00</span>-->
          <!--<span class="r" onClick=''><img src='../custom/images/drug_delete.png' class="icoDelete"/></span>-->
        <!--</li>-->
        <!--<li>-->
          <!--<img src='../custom/images/drug_clock.png' class="icoClock"/>-->
          <!--<span class="time" data-hour="" data-minute="" id="showTime">09:00</span>-->
          <!--<span class="r" onClick=''><img src='../custom/images/drug_delete.png' class="icoDelete"/></span>-->
        <!--</li>-->
      </ul>
      <div>
        <p class='addTimeBtn' onClick='' id="selectTime"><span class="link"><img src='../custom/images/drug_add.png'/>添加时间</span>
        </p>
      </div>
      <div class="commonDrug" style="display:none;">
        <h3 class="mTitle">常用药品（长按药品可删除）</h3>
        <ul class="listCommonDrug clearfix">
          <!--<li>-->
            <!--<span><i>加以探测到华</i>0.5g/片 3片<em style="display:none;"></em></span>-->
          <!--</li>-->
          <!--<li>-->
            <!--<span><i>加以探测到华</i>0.5g/片 3片<em></em></span>-->
          <!--</li>-->
        </ul>
      </div>
      <h3 class="mTitle">备注信息</h3>
      <div class="myTextareaBox">
        <textarea class="weui-textarea" placeholder="您可以填写相关用药信息" rows="3" maxlength="100"></textarea>
        <div class="weui-textarea-counter"><span id="num">0</span>/100</div>
      </div>
    </div>
  </div>
  <div class="custom-btm-fixed">
    <span class="custom-btm-btn" onclick="save()">保存</span>
  </div>
</div>
<!-- 选择用药的时候display:block; -->
<div class="mySelect" id="iosselectDrug" style="display:none;">
  <p class="otherDrugIpt"><input type="text" name="" placeholder="填写你找不到的药品名称" maxlength="5"/></p>
</div>

<script type="text/javascript" src="../lib/js/flexible.js"></script>
<script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
<script type="text/javascript" src="../lib/js/jquery.min.js"></script>
<script type="text/javascript" src="../custom/js/native.js"></script>
<script type="text/javascript" src="../custom/js/common.js"></script>
<script src="../custom/js/api.js"></script>
<script src="../lib/js/jquery-weui.js"></script>
<!-- 选药品 -->
<link rel="stylesheet" href="../lib/css/iosSelect.css">
<script src="../lib/js/iosSelect.js"></script>
<script type="text/javascript">
  FastClick.attach(document.body);
  $.toast.prototype.defaults.duration = 800;

  initDrugs();
  function initDrugs() {
    var iosProvinces = [
      {'id': '0', 'value': '阿司匹林', 'parentId': '0'},
      {'id': '1', 'value': '酵素粉', 'parentId': '0'},
      {'id': '2', 'value': '软骨鱼', 'parentId': '0'},
      {'id': '3', 'value': '柯贵吉', 'parentId': '0'},
      {'id': '3', 'value': '柯贵吉', 'parentId': '0'},
      {'id': '3', 'value': '柯贵吉', 'parentId': '0'},
      {'id': '4', 'value': '才几级', 'parentId': '0'}];
    var iosCitys = [
      {"value": "0卡博苹50mg/...", "parentId": "0"},
      {"value": "0卡博苹50mg/...", "parentId": "0"},
      {"value": "1卡博苹50mg/...", "parentId": "1"},
      {"value": "1卡博苹50mg/...", "parentId": "1"},
      {"value": "2卡博苹50mg/...", "parentId": "2"},
      {"value": "2卡博苹50mg/...", "parentId": "2"},
      {"value": "2卡博苹50mg/...", "parentId": "2"},
      {"value": "3卡博苹50mg/...", "parentId": "3"},
      {"value": "4卡博苹50mg/...", "parentId": "4"}];
    var selectDrugDom = $('#selectDrug');
    var showDrugDom = $('#showDrug');
    var drugNameDom = $('#drug-name');
    var drugDoseDom = $('#drug-dose');
    selectDrugDom.bind('click', function () {
      document.querySelector('#iosselectDrug').style.display = 'block';
      var oneLevelId = showDrugDom.attr('data-drug-name');
      var twoLevelId = showDrugDom.attr('data-drug-dose');
      var iosSelect1 = new IosSelect(2,
        [iosProvinces, iosCitys],
        {
          // title: '地址选择',
          container: '.mySelect',
          itemHeight: 35,
          headerHeight: 100,
          relation: [1, 1],
          oneLevelId: oneLevelId,
          twoLevelId: twoLevelId,
          callback: function (selectOneObj, selectTwoObj) {
            drugNameDom.val(selectOneObj.id);
            drugNameDom.attr('drug-name', selectOneObj.value);
            drugDoseDom.val(selectTwoObj.id);
            drugDoseDom.attr('drug-dose', selectTwoObj.value);

            showDrugDom.attr('data-drug-name', selectOneObj.id);
            showDrugDom.attr('data-drug-dose', selectTwoObj.id);
            showDrugDom.html(selectOneObj.value + ' ' + selectTwoObj.value);
            document.querySelector('#iosselectDrug').style.display = 'none';
          }
        });
    });
  }

  <!-- 时间显示 -->
  // var timeObj = {};
  var timeObj = localStorage.getItem('timeObj') && JSON.parse(localStorage.getItem('timeObj')) || {};
  initTime();
  function initTime() {
    var selectDateDom = $('#selectTime');
    // var showDateDom = $('#showTime');
    var hourData = function (callback) {
      var hours = [];
      for (var i = 0, len = 24; i < len; i++) {
        if(i<10){
          i = '0'+i;
        }
        hours.push({
          id: i,
          value: i + '时'
        });
      }
      callback(hours);
    };
    var minuteData = function (one, callback) {
      var minutes = [];
      for (var i = 0, len = 60; i < len; i++) {
        if(i<10){
          i = '0'+i;
        }
        minutes.push({
          id: i,
          value: i + '分'
        });
      }
      callback(minutes);
    };
    selectDateDom.bind('click', function () {
      document.querySelector('#iosselectDrug').style.display = 'none';
      // var oneLevelId = showDateDom.attr('data-hour');
      // var twoLevelId = showDateDom.attr('data-minute');
      var iosSelect2 = new IosSelect(2,
        [hourData, minuteData],
        {
          title: '添加时间',
          itemHeight: 35,
          itemShowCount: 9,
          oneLevelId: '08',
          // twoLevelId: twoLevelId,
          callback: function (selectOneObj, selectTwoObj) {
            // showDateDom.attr('data-hour', selectOneObj.id);
            // showDateDom.attr('data-minute', selectTwoObj.id);
            var timeObjValue = selectOneObj.value + ':' + selectTwoObj.value;
            if(!timeObj[timeObjValue]){
              timeObj[timeObjValue] = timeObjValue;
              addTimeHtml(timeObj);
            }else{
              $.toast('此用药时间已添加', 'text');
            }
          }
        });
    });
  }

  //添加时间
  addTimeHtml();
  function addTimeHtml(_timeObj) {
    //此行代码是  存储  时间的
    // !_timeObj ? (localStorage.getItem('timeObj') ? _timeObj = JSON.parse(localStorage.getItem('timeObj')) : false) : localStorage.setItem('timeObj', JSON.stringify(timeObj));
    if(_timeObj){
      var timeHtml = '';
      var keyArr = Object.keys(_timeObj).sort();
      keyArr.length >= 1 ? keyArr.map(function (val) {
        $('.listDrugTime').html('');
        timeHtml +=
          '      <li>\n' +
          '        <img src=\'../custom/images/drug_clock.png\' class="icoClock"/>\n' +
          '        <span class="time" data-hour="" data-minute="" id="showTime">'+ val +'</span>\n' +
          '        <span class="r" onClick="deleteTime(\''+val+'\')"><img src=\'../custom/images/drug_delete.png\' class="icoDelete"/></span>\n' +
          '      </li>';
        $('.listDrugTime').append(timeHtml);
        if(keyArr.length === 6){
          $('#selectTime').hide();
        }else{
          $('#selectTime').show();
        }
      }) : $('.listDrugTime').html('');
    }
  }

  //删除时间
  function deleteTime(val){
    delete timeObj[val];
    addTimeHtml(timeObj);
  }

  //备注信息字段长度
  $('.weui-textarea').bind('input', function () {
    var reasonLen = $(this).val().length;
    $('#num').text(reasonLen);
  });

  //服用剂量输入限制,最多输入一位小数
  function takeDose(obj){
    obj.value = obj.value.match(/\d+\.?\d{0,1}/,'');
    if(Number(obj.value) > 100){
      obj.value = 100;
    }
  }

  //保存
  var mecObj = localStorage.getItem('mecObj') && JSON.parse(localStorage.getItem('mecObj')) || {};  //口服药数据
  var mecObjInsulin = localStorage.getItem('mecObjInsulin') && JSON.parse(localStorage.getItem('mecObjInsulin')) || {};   //胰岛素数据
  var anotherType;
  function save() {
    var mecNum = $('.itext').val(), showDrugText = $('#showDrug').text();
    if(showDrugText === '选择用药'){
      $.toast('请填写药品名称', 'text');
      return false;
    }else if(mecNum === '' || null){
      $.toast('请填写服用剂量', 'text');
      return false;
    }else if($.isEmptyObject(timeObj)){
      $.toast('请添加用药时间', 'text');
      return false;
    }
    if(anotherType === '胰岛素'){
      if(mecObjInsulin[showDrugText]){
        delete mecObjInsulin[showDrugText];
      }
      mecObjInsulin[showDrugText] = showDrugText;
      showCommonDrugList(mecObjInsulin, anotherType);   //这一步会存储胰岛素常用药品
    }else{
      if(mecObj[showDrugText]){
        delete mecObj[showDrugText];
      }
      mecObj[showDrugText] = showDrugText;
      showCommonDrugList(mecObj, anotherType);   //这一步会存储口服药常用药品
    }
  }

  //常用药品
  function drugNum(mec, type) {
    var drugKeyArr = Object.keys(mec).reverse(), drugHtml = '', _listCommonDrug = $('.listCommonDrug');
    if(drugKeyArr.length === 6){
      delete mec[drugKeyArr.pop()]
    }
    console.log(mec, type)
    //存储常用药品
    type === '胰岛素' ? localStorage.setItem('mecObjInsulin', JSON.stringify(mec)) : localStorage.setItem('mecObj', JSON.stringify(mec));
    drugKeyArr.length >= 1 ? drugKeyArr.map(function (val) {
      _listCommonDrug.html('');
      drugHtml += '<li><span>'+ val +'</span></li>';
      _listCommonDrug.append(drugHtml);
    }) : (_listCommonDrug.html(''), $('.commonDrug').hide());
    longPressDel();
  }

  //长按删除
  function longPressDel() {
    var longClick =0, timeOutEvent, _this, commonDrugContent;
    $(".listCommonDrug li").bind({
      touchstart: function(e){
        e.preventDefault();
        _this = this;
        commonDrugContent = $(_this).find('span').text();
        longClick=0;//设置初始为0
        timeOutEvent = setTimeout(function(){
          //此处为长按事件-----在此显示遮罩层及删除按钮
          longClick=1;//假如长按，则设置为1
          $.confirm({
            title: '提示',
            text: '是否删除'+ commonDrugContent,
            onOK: function () {
              //点击确认
              if(anotherType === '胰岛素'){
                delete mecObjInsulin[commonDrugContent];
                drugNum(mecObjInsulin, '胰岛素');
              }else{
                delete mecObj[commonDrugContent];
                drugNum(mecObj);
              }

            },
            onCancel: function () {
              return false;
            }
          });
        },600);
      },
      touchmove: function(e){
        e.preventDefault();
        clearTimeout(timeOutEvent);
        timeOutEvent = 0;
      },
      touchend: function(e){
        e.preventDefault();
        _this = this;
        commonDrugContent = $(_this).find('span').text();
        clearTimeout(timeOutEvent);
        if(timeOutEvent !== 0 && longClick === 0){
          //此处为点击事件
          $('#showDrug').text(commonDrugContent)
        }
        return false;
      }
    });
  }

  //是否展示常用药品
  showCommonDrugList();
  function showCommonDrugList(mecObj, type) {
    !mecObj ? (localStorage.getItem('mecObj') ? mecObj = JSON.parse(localStorage.getItem('mecObj')) : false) : false;
    if(!$.isEmptyObject(mecObj)){
      $('.commonDrug').show();
      drugNum(mecObj, type);
    }else{
      $('.commonDrug').hide();
    }
  }

  $(function () {
    //判断当前是口服药页面还是胰岛素页面
    $('.tabWrap span').bind('click', function () {
      $('.tabWrap span').removeClass();
      $(this).addClass('current');
      if($(this).text() === '胰岛素'){
        $('.unit').text('U');
        anotherType = '胰岛素';
        showCommonDrugList(mecObjInsulin, '胰岛素');
      }else{
        $('.unit').text('片');
        anotherType = '';
        showCommonDrugList(mecObj);
      }
    })
  })
</script>

</body>
</html>
