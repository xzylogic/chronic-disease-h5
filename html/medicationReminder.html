<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>用药提醒</title>
  <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css" />
  <link rel="stylesheet" type="text/css" href="../lib/css/jquery-weui.css" />
  <link rel="stylesheet" type="text/css" href="../custom/css/common.css" />
  <link rel="stylesheet" type="text/css" href="../custom/css/medicationReminder.css" />

</head>

<body>
<div class="MedicationReminder" style="display:block;">
    <div class="scroll-wrap" style="padding-bottom: 1px;">
      <!--<div class="weui-cell weui-cell_swiped">
        <div class="weui-cell__bd">
          <div class="reminderListLeft" onClick=''>
            <span class="name">阿米详细讲究</span>
            <p class="daytime"><label>每天：</label><span>11:00</span><span>11:00</span></p>
            <p><label>剂量：</label><span class="fc_orange">4ml</span></p>
          </div>
          <label for="switchCP1" class="weui-switch-cp">
            <input id="switchCP1" class="weui-switch-cp__input" type="checkbox" checked="checked">
            <div class="weui-switch-cp__box"></div>
          </label>
        </div>
        <div class="weui-cell__ft">
          <a class="weui-swiped-btn delete-swipeout" href="javascript:"><i>删除</i></a>
        </div>
      </div>
      <div class="weui-cell weui-cell_swiped">
        <div class="weui-cell__bd">
          <div class="reminderListLeft" onClick=''>
            <span class="name">阿米详细讲究</span>
            <p class="daytime"><label>每天：</label><span>11:00</span><span>11:00</span></p>
            <p><label>剂量：</label><span class="fc_orange">4ml</span></p>
          </div>
          <label for="switchCP2" class="weui-switch-cp">
            <input id="switchCP2" class="weui-switch-cp__input" type="checkbox" checked="checked">
            <div class="weui-switch-cp__box"></div>
          </label>
        </div>
        <div class="weui-cell__ft">
          <a class="weui-swiped-btn delete-swipeout" href="javascript:"><i>删除</i></a>
        </div>
      </div>-->
    </div>
    <div class="custom-btm-fixed" style="display: none;">
        <span class="custom-btm-btn" onclick="addRemind()">添加提醒</span>
    </div>
</div>

<div class="custom-nodata nodataReminder" style="display:none;">
  <img src="../custom/images/drug_nodata.png" />
  <p>暂无用药提醒</p>
  <p class="btnboxs" onClick='addRemind()'><a class="btn">添加提醒</a></p>
</div>

  <script type="text/template" id="drugRemindList-Temp">
    <div class="weui-cell weui-cell_swiped">
      <div class="weui-cell__bd">
        <div class="reminderListLeft" data-medicineId="{7}" data-name="{8}" data-fixedId="{9}" data-delFlag="{10}" data-remark="{11}" data-timesId="{12}" data-mecId="{13}" data-type="{14}">
          <span class="name">{0}</span>
          <p class="daytime"><label>每天：</label><span>{1}</span></p>
          <!--<p class="daytime"><label>每天：</label><span>11:00</span><span>11:00</span></p>-->
          <p><label>剂量：</label><span class="fc_orange">{2}</span><span>{6}</span></p>
          <!--<p><label>剂量：</label><span class="fc_orange">4ml</span></p>-->
        </div>
        <label for="{3}" class="weui-switch-cp">
          <input id="{3}" class="weui-switch-cp__input" type="checkbox" {5} data-id="{4}">
          <div class="weui-switch-cp__box"></div>
        </label>
      </div>
      <div class="weui-cell__ft">
        <a class="weui-swiped-btn delete-swipeout" href="javascript:" data-id="{4}"><i>删除</i></a>
      </div>
    </div>
  </script>
  <script type="text/javascript" src="../lib/js/flexible.js"></script>
  <script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
  <script type="text/javascript" src="../lib/js/jquery.min.js"></script>
  <script type="text/javascript" src="../custom/js/native.js"></script>
  <script type="text/javascript" src="../custom/js/common.js?v=3.7"></script>
  <script src="../lib/js/jquery-weui.js"></script>
  <script src="../custom/js/api.js"></script>
  <script>
    FastClick.attach(document.body);

    //注册页面活动状态事件
    nativeObj.RegisterFun(function (paramObj) {
      switch (paramObj.ACTION) {
        case "ACTIVEPAGE"://页面激活
          getRemindList();
          break;
      }
    });

    function addRemind(){
      NativeFunc({
        ACTION: "OPENURL",
        PARAM: {
          URL: nativeObj.htmlPath + '/medicationReminderDrug.html'
        }
      });
    }

    // 获取用药提醒列表
    getRemindList();
    function getRemindList() {
      var ajax_url = ajaxUrl.remindList;
      var ajax_fun = function(data){
        if(data.code === 0){
          // console.log('获取用药提醒列表',data.data);
          var html = '';
          var temp = $('#drugRemindList-Temp').html();
          $('.custom-nodata').hide();
          $('.custom-btm-fixed').show();
          data.data.content.length > 0 ? data.data.content.map(function (res, i) {
            var drugBrand = '', drugTime = '', dosage = '', drugUnit = '', drugMedicineId = '', drugName = '',
                drugId = res.id, drugDelFlag = res.delFlag, drugRemark = res.remark, drugTimesId = '', drugMecId = '', drugType = res.type;
            var drugFlag = (res.delFlag === '0' ? 'checked' : '');
            res.remindItems.map(function (items) {
              drugBrand += items.brand + ' ' + items.specification;
              dosage += items.dose;
              drugUnit += items.unit;
              drugMedicineId = items.medicineId;
              drugName = items.name;
              drugMecId = items.id;
            });
            res.remindTimes.map(function (times) {
              var time1 = times.remindTime.split(':');
              drugTimesId += times.id + '-';
              drugTime += time1[0] + ':' + time1[1] + ' ';
            });
            html += temp.format(drugBrand, drugTime, dosage, 'switchCP' + i, res.id, drugFlag, drugUnit, drugMedicineId, drugName, drugId, drugDelFlag, drugRemark, drugTimesId, drugMecId, drugType);
          }) : ($('.custom-nodata').show(), $('.custom-btm-fixed').hide());
          $('.scroll-wrap').html(html);

          //初始化删除
          $('.weui-cell_swiped').swipeout('open');
          var longClick =0, timeOutEvent;
          $('.reminderListLeft').bind({
            touchstart: function(e){
              // e.preventDefault();
              longClick=0;//设置初始为0
              timeOutEvent = setTimeout(function(){
                //此处为长按、滑动事件-----
                longClick=1;//假如长按，则设置为1
              },200);
            },
            touchmove: function(e){
              // e.preventDefault();
              clearTimeout(timeOutEvent);
              timeOutEvent = 0;
            },
            touchend: function(e){
              // e.preventDefault();
              clearTimeout(timeOutEvent);
              if(timeOutEvent !== 0 && longClick === 0){
                //此处为点击事件
                var brand = $(this).find('.name').text();
                var dose = $(this).find('.fc_orange').text();
                var time = $(this).find('.daytime').children('span').text();
                var medicineId = $(this).attr('data-medicineId');
                var name = $(this).attr('data-name');
                var id = $(this).attr('data-fixedId');
                var delFlag = $(this).attr('data-delFlag');
                var remark = $(this).attr('data-remark');
                var timesId = $(this).attr('data-timesId');
                var mecId = $(this).attr('data-mecId');
                var type = $(this).attr('data-type');
                NativeFunc({
                  ACTION: "OPENURL",
                  PARAM: {
                    URL: nativeObj.htmlPath + '/medicationReminderDrug.html?brand='+brand+'&dose='+dose+'&time='+time+'&medicineId='+medicineId+'&name='+name+'&id='+id+'&delFlag='+delFlag+'&remark='+remark+'&timesId='+timesId+'&mecId='+mecId+'&type='+type
                  }
                });
              }
              return false;
            }
          });
          $('.delete-swipeout').bind('click', function () {
            showMyloading();
            deleteRemind($(this).attr('data-id'), $(this).parents('.weui-cell'));
          });
          $('.weui-switch-cp__input').bind('click', function () {
            remindEnable($(this).attr('data-id'));
          });
        }else{
          $.toast(data.msg || '请求错误', 'text');
        }
        hideMyloading();
      };
      custom.ajaxRequest({url: ajax_url, data: {flag: 0, userId: localStorage.getItem('uid')}}, ajax_fun, false);
    }

    //启用、禁用用药提醒
    function remindEnable(id) {
      var ajax_url2 = ajaxUrl.remindEnable;
      var ajax_fun2 = function(data){
        if(data.code === 0){
          console.log('修改状态成功', data);
          // $.toast(data.msg || '修改状态成功', 'text');
        }else{
          $.toast(data.msg || '请求错误', 'text');
        }
        hideMyloading();
      };
      custom.ajaxRequest({type: 'POST', url: ajax_url2, data: JSON.stringify({id: id})}, ajax_fun2, false);
    }

    //删除用药提醒
    function deleteRemind(id, removeRemind) {
      var ajax_url3 = ajaxUrl.remindDelete;
      var ajax_fun3 = function(data){
        if(data.code === 0){
          console.log('删除成功', data);
          removeRemind.remove();
          if($('.weui-cell_swiped').length === 0){
            $('.custom-btm-fixed').hide();
            $('.custom-nodata').show();
          }
        }else{
          $.toast(data.msg || '请求错误', 'text');
        }
        hideMyloading();
      };
      custom.ajaxRequest({type: 'POST', url: ajax_url3, data: JSON.stringify({id: id})}, ajax_fun3, false);
    }
  </script>

</body>
</html>
