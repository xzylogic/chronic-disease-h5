<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>糖尿病</title>
  <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css"/>
  <link rel="stylesheet" type="text/css" href="../lib/css/jquery-weui.css"/>
  <link rel="stylesheet" type="text/css" href="../custom/css/common.css"/>
  <link rel="stylesheet" type="text/css" href="../custom/css/index.css"/>

</head>

<body>
<div class="homeBox">
  <div class="topBg">
    <p class="toplink" onClick='addMore()'>
      <span><em>添加更多</em></span>
    </p>
    <div class="riskDataWrap">
      <div class="circleCon nodataCircleCon" onClick='' style="display:block;">
        <strong>&nbsp;</strong>
        <em class="no"><!-- 您25未测量血糖 --></em>
        <em>mmol/L</em>
      </div>
      <div class="circleCon" onClick='' style="display:none;">
        <strong>
          血糖正常
        </strong>
        <span><em>24</em></span>
        <em>mmol/L</em>
      </div>
      <div class="circleCon riskDataCircleCon" onClick='' style="display:none;">
        <strong>
          血糖偏低
        </strong>
        <span><em>24</em><i class='down'></i></span>
        <em>mmol/L</em>
      </div>
      <div class="circleCon riskDataCircleCon" onClick='' style="display:none;">
        <strong>
          血糖偏高
        </strong>
        <span><em>24</em><i class='up'></i></span>
        <em>mmol/L</em>
      </div>
      <ul>
        <li>
          <span class="glyHe">&nbsp;</span><br/>
          <em>糖化血红蛋白</em>
          <p class="line"></p>
        </li>
        <li>
          <span class="bloodRate">&nbsp;</span><br/>
          <!--value.match(/\d+\.?\d{0,1}/,'');-->
          <em>血糖达标率(年)</em>
          <p class="line"></p>
        </li>
        <li>
          <span>
              <strong class="ifQuelified">&nbsp;</strong>
          </span><br/>
          <em>是否合格</em>
        </li>
      </ul>
    </div>
  </div>
  <ul class="homeUl homeUl1 ">
    <li>
      <span onClick='goRisk()'><img src='../custom/images/icon1.png'/>风险评估</span>
    </li>
    <li>
      <span onClick='goMeasure()'><img src='../custom/images/icon2.png'/>体征测量</span>
    </li>
  </ul>
  <p class="border-top"></p>
  <ul class="homeUl homeUl2 ">
    <li>
      <span onClick='goMedicine()'><img src='../custom/images/icon3.png'/><br/>用药提醒</span>
    </li>
    <li>
      <span onClick='goPlan()'><img src='../custom/images/icon4.png'/><br/>随访计划</span>
    </li>
    <li>
      <span onClick='goReport()'><img src='../custom/images/icon5.png'/><br/>报告查看</span>
    </li>
    <li class="doctorAdvice">
      <span onClick='goAdvice()'><em><img src='../custom/images/icon9.png'/></em><br/>医生建议</span>
    </li>
  </ul>
</div>
<!-- 添加更多弹出层 -->
<div class="popup-wrap" style="display:none;">
  <div class="lightbox" onclick="hideMore()"></div>
  <div class="popup-con popup-con-middle">
    <span class="close" onclick="hideMore()"></span>
    <ul class="moreUl clearfix">
      <li onClick='goPressure()'><span><img src='../custom/images/icon10.png'/><br/>血压</span></li>
      <li onClick='goGly()'><span><img src='../custom/images/icon11.png'/><br/>糖化血红蛋白</span></li>
      <li onClick='goHeightWeight()'><span><img src='../custom/images/icon12.png'/><br/>身高体重</span></li>
    </ul>
  </div>
</div>
<script type="text/template" id="bloodData-Temp">
  <div class="circleCon {3}">
    <strong>
      {0}
    </strong>
    <span><em class="{4}">{1}</em><i class='{2}'></i></span>
    <em>mmol/L</em>
  </div>
  <ul>
    <li>
      <span class="glyHe">&nbsp;</span><br/>
      <em>糖化血红蛋白</em>
      <p class="line"></p>
    </li>
    <li>
      <span class="bloodRate">&nbsp;</span><br/>
      <!--value.match(/\d+\.?\d{0,1}/,'');-->
      <em>血糖达标率(年)</em>
      <p class="line"></p>
    </li>
    <li>
      <span>
        <strong class="ifQuelified">&nbsp;</strong>
      </span><br/>
      <em>是否合格</em>
    </li>
  </ul>
</script>
<script type="text/javascript" src="../lib/js/flexible.js"></script>
<script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
<script type="text/javascript" src="../lib/js/jquery.min.js"></script>
<script type="text/javascript" src="../custom/js/native.js"></script>
<script type="text/javascript" src="../custom/js/common.js"></script>
<script src="../custom/js/api.js"></script>
<script>
  FastClick.attach(document.body);

  setTimeout(function () {
    nativeObj.RegisterFun(function () {
      loadData();
    })
    // nativeObj.RegisterFun(function (paramObj) {
    //   switch (paramObj.ACTION) {
    //     case "ACTIVEPAGE"://页面激活
    //       //
    //       break;
    //   }
    // });
  }, 100);

  function addMore() {
    $('.popup-wrap').show();
  }

  function hideMore() {
    $('.popup-wrap').hide();
  }

  function goRisk() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/diabetesType.html'
      }
    });
  }

  function goMeasure() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath+ '/../../healthcloud-measure-web/html/measurementHistory.html'
      }
    });
  }

  function goMedicine() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/medicationReminder.html'
      }
    });
  }

  function goPlan() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/followUpPlan.html'
      }
    });
  }

  function goReport() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/followUpReport.html'
      }
    });
  }

  function goAdvice() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/doctorAdvice.html'
      }
    });
  }

  //以下三个函数跳转至体征测量相关页面
  function goPressure() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath+ '/../../healthcloud-measure-web/html/bloodPressure/bloodPressureAdd.html?card_type=82'
      }
    });
  }

  function goGly() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/../../healthcloud-measure-web/html/hemoglobin/hemoglobinAdd.html?card_type=82'
      }
    });
  }

  function goHeightWeight() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath+ '/../../healthcloud-measure-web/html/BMI/bmiAdd.html?card_type=82'
      }
    });
  }

  var pageData = {};
  var code = getParams('code');
  showMyloading();
  //获取token
  var pro = function () {
    return new Promise(function (resolve, reject) {
      $.ajax({
        type: "GET",
        url: ajaxUrl.userGetTokenByAuthCode,
        data: {'authCode': code},
        beforeSend: function (request) {
          // request.setRequestHeader('token', localStorage.getItem('netToken'));
          request.setRequestHeader('channelCode', getParams('channelCode') || localStorage.getItem('channelCode'));
          request.setRequestHeader('lightAppCode', getParams('lightAppCode') || localStorage.getItem('lightAppCode'));
          // request.setRequestHeader('appid', getParams('appid') || localStorage.getItem('appid'));
          request.setRequestHeader('timestamp', new Date().getTime());
        },
        success: function (data) {
          var tokenData = data.data;
          if (data.code === 0) {
            localStorage.setItem('netToken', tokenData.token);
            localStorage.setItem('uid', tokenData.uid);
            localStorage.setItem('channelCode', tokenData.channelCode);
            localStorage.setItem('lightAppCode', tokenData.lightAppCode);
            localStorage.setItem('appid', tokenData.appid);
            localStorage.setItem('accountId', tokenData.accountId);
            localStorage.setItem('requestUrl', nativeObj.htmlPath+'/../../healthcloud-measure-web/html');
            pageData = {
              netToken: tokenData.token,
              uid: tokenData.uid,
              channelCode: tokenData.channelCode,
              lightAppCode: tokenData.lightAppCode,
            };
            // console.log(localStorage.getItem('requestUrl'));
            resolve();
          } else {
            hideMyloading();
            pageData = {
              netToken: localStorage.getItem('netToken'),
              uid: localStorage.getItem('uid'),
              channelCode: localStorage.getItem('channelCode'),
              lightAppCode: localStorage.getItem('lightAppCode'),
            };
            if (!pageData.netToken) {
              $.toast(data.msg || '请求错误', 'text');
            }else{
              resolve();
            }
          }
        },
        error: function (err) {
          hideMyloading();
          console.log(err);
        }
      });
    })
  };

  //获取血糖记录
  function getBloodGlucose(){
    return new Promise(function (resolve, reject) {
      $.ajax({
        url: ajaxUrl.bloodGlucoseRecord + '?uid=' + pageData.uid + '&accountId=' + localStorage.getItem('accountId'),
        type: "GET",
        // contentType: 'application/json; charset=utf-8',
        beforeSend: function (request) {
          request.setRequestHeader('token', pageData.netToken);
          request.setRequestHeader('channelCode', pageData.channelCode);
          request.setRequestHeader('lightAppCode', pageData.lightAppCode);
          request.setRequestHeader('appid', localStorage.getItem('appid'));
          request.setRequestHeader('request-id', randomWord(true));
          request.setRequestHeader('timestamp', new Date().getTime());
        },
        success: function (data) {
          console.log('获取血糖',data);
          if(data.code === 0){
            resolve(data.data);
          }else{
            $.toast(data.msg || '请求错误~', 'text');
          }
        },
        error: function (err) {
          hideMyloading();
          console.log(err);
        }
      });
    });
  }

  // 获取医生建议
  function getDoctorAdvice(){
    return new Promise(function (resolve, reject) {
      $.ajax({
        url: ajaxUrl.doctorAdviceDetail + '?flag=0&uid=3a24cb5b173e4d6597f62a95d04e3340',
        // url: ajaxUrl.doctorAdviceDetail + '?flag=0&uid=' + pageData.uid,
        type: "GET",
        beforeSend: function (request) {
          request.setRequestHeader('token', pageData.netToken);
          request.setRequestHeader('channelCode', pageData.channelCode);
          request.setRequestHeader('lightAppCode', pageData.lightAppCode);
          request.setRequestHeader('appid', localStorage.getItem('appid'));
          request.setRequestHeader('request-id', randomWord(true));
          request.setRequestHeader('timestamp', new Date().getTime());
        },
        success: function (data) {
          console.log('医生建议:',data);
          if(data.code === 0){
            resolve(data.data);
          }else{
            $.toast(data.msg || '请求错误~', 'text');
          }
        },
        error: function (err) {
          hideMyloading();
          console.log(err);
        }
      });
    });
  }

  //首页进入请求接口、加载数据
  loadData();
  function loadData() {
    pro().then(function () {
      return Promise.all([getBloodGlucose(), getDoctorAdvice()])
    }).then(function (res) {
      // console.log(res);
      // console.log(res[0].glu)
      var html = '';
      var temp = $('#bloodData-Temp').html();
      var ifAbnormal = '', status = '', noData = '', showStatus = '';
      if(res[0].glu && res[0].glu.value){
        switch (res[0].glu.isAbnormal) {
          case 0:
            showStatus = '血糖正常';
            break;
          case 1:
            showStatus = '血糖异常';
            ifAbnormal = 'riskDataCircleCon';
            status = 'up';
            break;
          case 2:
            showStatus = '血糖异常';
            ifAbnormal = 'riskDataCircleCon';
            status = 'down';
            break;
          default:
            break;
        }
        // var aaa = "2019-03-01 09:00:00";
        // var oldTime = aaa.split(' ')[0];
        var oldTime = res[0].glu.detectTime.split(' ')[0];
        var getNowDate = new Date().toLocaleDateString().split('/');
        if(getNowDate[1] < 10){
          getNowDate[1] = '0' + getNowDate[1];
        }
        if(getNowDate[2] < 10){
          getNowDate[2] = '0'+ getNowDate[2];
        }
        var nowDate = getNowDate.join('-');
        var dateStart = new Date(oldTime);
        var dateEnd = new Date(nowDate);
        var difValue = (dateEnd - dateStart) / (1000 * 60 * 60 * 24);
        // console.log(difValue);

        if(difValue >= 2){
          // res[0].glu.abnormal = '';
          res[0].glu.value = '';
          ifAbnormal = 'nodataCircleCon';
          noData = 'no';
        }
        html += temp.format(showStatus, res[0].glu.value, status, ifAbnormal, noData);
        $('.riskDataWrap').html(html);
        if(difValue >= 2){
          $('.no').text('您'+ difValue +'天未测量血糖');
        }
        bindClick();
      }

      $('.glyHe').text(res[0].ghb || '— —');
      $('.bloodRate').text(res[0].gluComplianceRate || '— —');
      $('.ifQuelified').text(res[0].isQualified === '不显示' ? '— —' : res[0].isQualified);
      if(res[1].more){
        $('.doctorAdvice em').addClass('redDot');
      }
      hideMyloading();
    }).catch(function (err) {
      hideMyloading();
      console.log(err);
    });
  }

  bindClick();
  function bindClick() {
    $('.circleCon').bind('click', function () {
      NativeFunc({
        ACTION: "OPENURL",
        PARAM: {
          URL: nativeObj.htmlPath+ '/../../healthcloud-measure-web/html/bloodGlucose/bloodGlucoseAdd.html?card_type=82'
        }
      });
    });
  }
</script>

</body>
</html>
