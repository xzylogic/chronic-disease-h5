<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>慢病管理</title>
  <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css"/>
  <link rel="stylesheet" type="text/css" href="../lib/css/jquery-weui.css"/>
  <link rel="stylesheet" type="text/css" href="../custom/css/common.css"/>
  <link rel="stylesheet" type="text/css" href="../custom/css/index.css?v=1.0"/>

</head>

<body>
<div class="homeBox">
  <div class="topBg">
    <p class="toplink" onClick='addMore()'>
      <span><em>添加更多</em></span>
    </p>
    <div class="riskDataWrap">
      <div class="circleCon nodataCircleCon" onClick='' style="display:block;">
        <strong>&nbsp;</strong>
        <em class="no"><!-- 您25未测量血糖 --></em>
        <em>mmol/L</em>
      </div>
      <div class="circleCon" onClick='' style="display:none;">
        <strong>
          血糖正常
        </strong>
        <span><em>24</em></span>
        <em>mmol/L</em>
      </div>
      <div class="circleCon riskDataCircleCon" onClick='' style="display:none;">
        <strong>
          血糖偏低
        </strong>
        <span><em>24</em><i class='down'></i></span>
        <em>mmol/L</em>
      </div>
      <div class="circleCon riskDataCircleCon" onClick='' style="display:none;">
        <strong>
          血糖偏高
        </strong>
        <span><em>24</em><i class='up'></i></span>
        <em>mmol/L</em>
      </div>
      <ul>
        <li>
          <span class="glyHe">&nbsp;</span><br/>
          <em>糖化血红蛋白</em>
          <p class="line"></p>
        </li>
        <li>
          <span class="bloodRate">&nbsp;</span><br/>
          <!--value.match(/\d+\.?\d{0,1}/,'');-->
          <em>血糖达标率(年)</em>
          <p class="line"></p>
        </li>
        <li>
          <span>
              <strong class="ifQuelified">&nbsp;</strong>
          </span><br/>
          <em>是否合格</em>
        </li>
      </ul>
    </div>
  </div>
  <ul class="homeUl homeUl1 ">
    <li>
      <span onClick='goRisk()'><img src='../custom/images/icon1.png'/>风险评估</span>
    </li>
    <li>
      <span onClick='goMeasure()'><img src='../custom/images/icon2.png'/>体征测量</span>
    </li>
  </ul>
  <p class="border-top"></p>
  <ul class="homeUl homeUl2 ">
    <li>
      <span onClick='goMedicine()'><img src='../custom/images/icon3.png'/><br/>用药提醒</span>
    </li>
    <li>
      <span onClick='goPlan()'><img src='../custom/images/icon4.png'/><br/>随访计划</span>
    </li>
    <li>
      <span onClick='goReport()'><img src='../custom/images/icon5.png'/><br/>报告查看</span>
    </li>
    <li class="doctorAdvice">
      <span onClick='goAdvice()'><em><img src='../custom/images/icon9.png'/></em><br/>医生建议</span>
    </li>
  </ul>
</div>
<!-- 添加更多弹出层 -->
<div class="popup-wrap" style="display:none;">
  <div class="lightbox" onclick="hideMore()"></div>
  <div class="popup-con popup-con-middle">
    <span class="close" onclick="hideMore()"></span>
    <ul class="moreUl clearfix">
      <li onClick='goPressure()'><span><img src='../custom/images/icon10.png'/><br/>血压</span></li>
      <li onClick='goGly()'><span><img src='../custom/images/icon11.png'/><br/>糖化血红蛋白</span></li>
      <li onClick='goHeightWeight()'><span><img src='../custom/images/icon12.png'/><br/>身高体重</span></li>
    </ul>
  </div>
</div>
<script type="text/template" id="bloodData-Temp">
  <div class="circleCon {3}">
    <strong>
      {0}
    </strong>
    <span><em class="{4}">{1}</em><i class='{2}'></i></span>
    <em>mmol/L</em>
  </div>
  <ul>
    <li>
      <span class="glyHe">&nbsp;</span><br/>
      <em>糖化血红蛋白</em>
      <p class="line"></p>
    </li>
    <li>
      <span class="bloodRate">&nbsp;</span><br/>
      <!--value.match(/\d+\.?\d{0,1}/,'');-->
      <em>血糖达标率(年)</em>
      <p class="line"></p>
    </li>
    <li>
      <span>
        <strong class="ifQuelified">&nbsp;</strong>
      </span><br/>
      <em>是否合格</em>
    </li>
  </ul>
</script>
<script type="text/javascript" src="../lib/js/flexible.js"></script>
<script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
<script type="text/javascript" src="../lib/js/jquery.min.js"></script>
<script type="text/javascript" src="../custom/js/native.js?v=3.8"></script>
<script type="text/javascript" src="../custom/js/common.js?v=4.5"></script>
<script src="../custom/js/api.js?v=3.8"></script>
<script>
  FastClick.attach(document.body);

  //注册页面活动状态事件
  nativeObj.RegisterFun(function (paramObj) {
    switch (paramObj.ACTION) {
      case "ACTIVEPAGE"://页面激活
        loadData();
        break;
    }
  });

  function addMore() {
    $('.popup-wrap').show();
  }

  function hideMore() {
    $('.popup-wrap').hide();
  }

  function goRisk() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/diabetesType.html?v=1.15'
      }
    });
  }

  function goMeasure() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/../../healthcloud-measure-web/html/measurementHistory.html?from=1'
      }
    });
  }

  function goMedicine() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/medicationReminder.html?v=1.15'
      }
    });
  }

  function goPlan() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/followUpPlan.html'
      }
    });
  }

  function goReport() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/followUpReport.html'
      }
    });
  }

  function goAdvice() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/doctorAdvice.html'
      }
    });
  }

  //以下三个函数跳转至体征测量相关页面
  function goPressure() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/../../healthcloud-measure-web/html/bloodPressure/bloodPressureAdd.html?card_type=82'
      }
    });
  }

  function goGly() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/../../healthcloud-measure-web/html/hemoglobin/hemoglobinAdd.html?card_type=82'
      }
    });
  }

  function goHeightWeight() {
    NativeFunc({
      ACTION: "OPENURL",
      PARAM: {
        URL: nativeObj.htmlPath + '/../../healthcloud-measure-web/html/BMI/bmiAdd.html?card_type=82'
      }
    });
  }

  //跳转到身高体重页面缓存的值
  localStorage.setItem("height", 170);
  localStorage.setItem("weight", 60);

  var pageData = {};
  var code = getParams('code');
  //获取token
  function pro() {
    var ajax_url = ajaxUrl.userGetTokenByAuthCode;
    var defer1 = $.Deferred();
    var ajax_fun = function (data) {
      var tokenData = data.data;
      if (data.code === 0) {
        localStorage.setItem('netToken', tokenData.token);
        localStorage.setItem('uid', tokenData.uid);
        localStorage.setItem('channelCode', tokenData.channelCode);
        localStorage.setItem('lightAppCode', tokenData.lightAppCode);
        localStorage.setItem('appid', tokenData.appid);
        localStorage.setItem('accountId', tokenData.accountId);
        localStorage.setItem('requestUrl', nativeObj.htmlPath + '/../../healthcloud-measure-web/html');
        localStorage.setItem('idcard', tokenData.idcard || '');
        localStorage.removeItem('iotUid');
        pageData = {
          netToken: tokenData.token,
          uid: tokenData.uid,
          channelCode: tokenData.channelCode,
          lightAppCode: tokenData.lightAppCode,
        };
        defer1.resolve();
      } else {
        pageData = {
          netToken: localStorage.getItem('netToken'),
          uid: localStorage.getItem('uid'),
          channelCode: localStorage.getItem('channelCode'),
          lightAppCode: localStorage.getItem('lightAppCode'),
        };
        if (!pageData.netToken) {
          $.toast(data.msg || '请求错误', 'text');
        } else {
          defer1.resolve();
        }
      }
      hideMyloading();
    };
    custom.ajaxRequest({url: ajax_url, data: {authCode: code}}, ajax_fun, false);
    return defer1.promise();
  }

  //获取血糖记录
  function getBloodGlucose() {
    var defer2 = $.Deferred();
    var ajax_url2 = ajaxUrl.bloodGlucoseRecord;
    var ajax_fun2 = function (data) {
      if (data.code === 0) {
        defer2.resolve(data.data);
      } else {
        $.toast(data.msg || '请求错误~', 'text');
      }
      hideMyloading();
    };
    custom.ajaxRequest({url: ajax_url2, data: {uid: pageData.uid, accountId: localStorage.getItem('accountId'), format: 'json'}}, ajax_fun2, false);
    return defer2.promise();
  }

  // 获取医生建议
  function getResidentAccountId() {
    var defer3 = $.Deferred();
    var ajax_url3 = ajaxUrl.residentAccountId;
    var ajax_fun3 = function (data) {
      if (data.code === 0) {
        defer3.resolve(data.data);
      } else {
        $.toast(data.msg || '请求错误~', 'text');
      }
      hideMyloading();
    };
    custom.ajaxRequest({url: ajax_url3, data: {accountId: localStorage.getItem('accountId'), format: 'json'}}, ajax_fun3, false);
    return defer3.promise();
  }

  //首页进入请求接口、加载数据
  loadData();
  function loadData() {
    pro().then(function () {
      return $.when(getBloodGlucose(), getResidentAccountId())
    }).done(function (res0, res1) {
      var html = '';
      var temp = $('#bloodData-Temp').html();
      var ifAbnormal = '', status = '', noData = '', showStatus = '';
      if (res0.glu && res0.glu.value) {
        switch (res0.glu.isAbnormal) {
          case '0':
            showStatus = '血糖正常';
            break;
          case '1':
            showStatus = '血糖异常';
            ifAbnormal = 'riskDataCircleCon';
            status = 'up';
            break;
          case '2':
            showStatus = '血糖异常';
            ifAbnormal = 'riskDataCircleCon';
            status = 'down';
            break;
          default:
            break;
        }
        var oldTime = res0.glu.detectTime && res0.glu.detectTime.split(' ')[0];
        var nowDate = new Date().Format('yyyy-MM-dd');
        var dateStart = new Date(oldTime);
        var dateEnd = new Date(nowDate);
        var difValue = parseInt((dateEnd - dateStart) / (1000 * 60 * 60 * 24));

        if (!(oldTime === nowDate)) {
          res0.glu.value = '';
          showStatus = '&nbsp;';
          ifAbnormal = 'nodataCircleCon';
          noData = 'no';
          status = '';
        }

        html += temp.format(showStatus, res0.glu.value, status, ifAbnormal, noData);
        $('.riskDataWrap').html(html);
        if (difValue >= 2) {
          $('.no').text('您' + difValue + '天未测量血糖');
        }
        bindClick();
      }

      $('.glyHe').text(res0.ghb && (res0.ghb + '%') || '— —');
      $('.bloodRate').text(res0.gluComplianceRate || '— —');
      $('.ifQuelified').text(res0.isQualified === '不显示' ? '— —' : res0.isQualified);
      // if (res1.more) {
      //   $('.doctorAdvice em').addClass('redDot');
      // }
      hideMyloading();
    }).fail(function (err) {
      hideMyloading();
      console.log(err);
    });
  }

  bindClick();
  function bindClick() {
    $('.circleCon').bind('click', function () {
      NativeFunc({
        ACTION: "OPENURL",
        PARAM: {
          URL: nativeObj.htmlPath + '/../../healthcloud-measure-web/html/bloodGlucose/bloodGlucoseAdd.html?card_type=82'
        }
      });
    });
  }
</script>

</body>
</html>
