<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>医生建议</title>
  <link rel="stylesheet" type="text/css" href="../lib/css/weui.min.css"/>
  <link rel="stylesheet" type="text/css" href="../lib/css/jquery-weui.css"/>
  <link rel="stylesheet" type="text/css" href="../custom/css/common.css"/>
  <link rel="stylesheet" type="text/css" href="../custom/css/doctorAdvice.css"/>
</head>
<style>
  .doctorAdviceBox{
    position: relative;
    height: 100%;
    background-color: #f4f4f4;
    z-index:99;
  }
  .have-data-box{
    position: absolute;
    top:-2.2rem;
    bottom:0;
    margin-top:0;
    width: 100%;
    box-sizing: border-box;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }
  .pull-refresh-loading {
    padding: 0;
    height: 2.2rem;
    line-height: 2.2rem;
    font-size: .7rem;
    color: #999;
    text-align: center;
  }
  .item:after{content: " ";display: inline-block;position: absolute;top:10px;right: 1px;background: url(../custom/images/darrow.png);width: 0.4rem;height: 0.213333rem;margin-top:-0.106667rem;background-size: contain;}
  .showItem .item:after{background-image: url(../custom/images/uparrow.png)}
</style>
<body>
<div class="doctorAdviceBox">
  <div class="have-data-box">
    <!--显示下拉标签-->
    <div class="weui-pull-to-refresh__layer pull-refresh-loading">
      <div class='weui-pull-to-refresh__arrow'></div>
      <div class='weui-pull-to-refresh__preloader'></div>
      <div class="down">下拉刷新</div>
      <div class="up">释放刷新</div>
      <div class="refresh">正在刷新</div>
      <span id="last-Time"></span>
    </div>
    <ul class="newadviceList">
      <!--<li>-->
        <!--<p><label>异常类型</label><span>血糖首次异常,血压首次异常,非首次舒张压过低</span></p>-->
        <!--<p><label>异常数据</label>-->
          <!--<span class="item">2018-11-28&nbsp;&nbsp;午餐后&nbsp;&nbsp;<span><em class="abnormal">17.4<img src="../custom/images/sup.png"></em>&nbsp;&nbsp;mmol/L</span></span>-->
          <!--<span>2018-11-28&nbsp;&nbsp;午餐后&nbsp;&nbsp;<span><em class="abnormal">17.4<img src="../custom/images/sup.png"></em>&nbsp;&nbsp;mmol/L</span></span>-->
          <!--<span>2018-11-28&nbsp;&nbsp;午餐后&nbsp;&nbsp;<span><em class="abnormal">17.4<img src="../custom/images/sup.png"></em>&nbsp;&nbsp;mmol/L</span></span>-->
        <!--</p>-->
        <!--<p><label>干预时间</label><span>2018-12-20</span></p>-->
        <!--<p><label>医生姓名</label><span>肖金金</span></p>-->
        <!--<p><label>医疗机构</label><span>浦东新区张江社区卫生服务中心</span></p>-->
        <!--<p><label>医生建议</label><span>您好,您血糖首次异常,请及时到医院就诊或咨询医生</span></p>-->
      <!--</li>-->
    </ul>
    <div id="load-more" class="weui-loadmore" style="display: none;">
      <i class="weui-loading"></i>
      <span class="weui-loadmore__tips">正在加载</span>
    </div>
  </div>
</div>
<div class='custom-nodata' style="display:none;">
  <img src="../custom/images/nodata.png">
  <p>暂无建议</p>
</div>

<script type="text/template" id="dovtorAdvice-Temp">
  <li>
    <p><label>异常类型</label><span>{0}</span></p>
    <p><label>异常数据</label>{1}<span style="display:none">{6}</span></p>
    <p><label>干预时间</label><span>{2}</span></p>
    <p><label>医生姓名</label><span>{3}</span></p>
    <p><label>医疗机构</label><span>{4}</span></p>
    <p><label>医生建议</label><span>{5}</span></p>
  </li>
</script>
<script type="text/javascript" src="../lib/js/flexible.js"></script>
<script type="text/javascript" src="../lib/js/fastclick.min.js"></script>
<script type="text/javascript" src="../lib/js/jquery.min.js"></script>
<script type="text/javascript" src="../lib/js/jquery-weui.js"></script>
<script type="text/javascript" src="../custom/js/native.js"></script>
<script type="text/javascript" src="../custom/js/common.js?v=3.7"></script>
<script src="../custom/js/api.js"></script>
<script>
  FastClick.attach(document.body);

  $(function () {
    // 获取医生建议
    function getDoctorAdvice(page) {
      var defer = $.Deferred();
      var ajax_url = ajaxUrl.doctorAdviceDetail;
      var ajax_fun = function (data) {
        if (data.code === 0) {
          defer.resolve(data.data);
        } else {
          $.toast(data.msg || '请求错误~', 'text');
        }
        hideMyloading();
      };
      custom.ajaxRequest({url: ajax_url, data: {page: page, limit: 10, uid: localStorage.getItem('uid'), accountId: localStorage.getItem('accountId'), format: 'json'}}, ajax_fun, false);
      return defer.promise();
    }

    var html = '';
    var adviceData = {
      // pageStatus: '血糖异常',
      dataList: $('.have-data-box'),
      loading: false,   //上拉加载时防止多次加载
      moreData: false,  //是否有更多数据
      page: 1,  //页数
    };

    indexDoctorAdvice(adviceData.page);
    function indexDoctorAdvice(page) {
      getDoctorAdvice(page).done(function (res) {
        // console.log(res);
        adviceData.moreData = res.more;
        var temp = $('#dovtorAdvice-Temp').html();
        alert(typeof page)
        if (page === 1 && res.content.length === 0) {
          alert(page)
          alert('a')
          $('.custom-nodata').show();
        } else {
          alert(page)
          alert('b')
          $('.weui-loadmore').hide();
          adviceData.loading = false;
          var meal = '', flagStatus = '', flagStatus2 = '', flagImg = '', flagImg2 = '', flagItem = '';
          res.content.length > 0 ? res.content.map(function (data) {
            var abnormalHtml = '', abnormalHtml2 = '', indexItem = 0;
            data.gluList && data.gluList.map(function (res) {
              if(data.gluList.length === 1){
                flagItem = '';
              }else{
                flagItem = 'item';
              }
              switch (res.type) {
                case "0":
                  meal = '早餐前';
                  break;
                case "1":
                  meal = '早餐后';
                  break;
                case "2":
                  meal = '午餐前';
                  break;
                case "3":
                  meal = '午餐后';
                  break;
                case "4":
                  meal = '晚餐前';
                  break;
                case "5":
                  meal = '晚餐后';
                  break;
                case "6":
                  meal = '睡前';
                  break;
                case "7":
                  meal = '凌晨';
                  break;
                default :
                  meal = '随机';
                  break;
              }
              switch (res.flag) {
                case '0':
                  flagStatus = '';
                  flagImg = '';
                  break;
                case '1':
                  flagStatus = 'abnormal';
                  flagImg = '../custom/images/sup.png';
                  break;
                case '2':
                  flagStatus = 'abnormal';
                  flagImg = '../custom/images/down-arrow1.png';
                  break;
                default:
                  break;
              }
              if(indexItem === 0){
                abnormalHtml += '<span class='+ flagItem +'>'+ res.detectTime +'&nbsp;&nbsp;'+ meal +'&nbsp;&nbsp;<em class='+ flagStatus +'>'+ res.gluValue +'<img src='+ flagImg +'></em>&nbsp;&nbsp;mmol/L</span><br>';
              }else{
                abnormalHtml2 += '<span>'+ res.detectTime +'&nbsp;&nbsp;'+ meal +'&nbsp;&nbsp;<em class='+ flagStatus +'>'+ res.gluValue +'<img src='+ flagImg +'></em>&nbsp;&nbsp;mmol/L</span><br>';
              }
              indexItem++;
            });

            data.sysDiaList && data.sysDiaList.map(function (res) {
              if(data.sysDiaList.length === 1){
                flagItem = '';
              }else{
                flagItem = 'item';
              }
              switch (res.diaFlag) {
                case 0:
                  flagStatus = '';
                  flagImg = '';
                  break;
                case 1:
                  flagStatus = 'abnormal';
                  flagImg = '../custom/images/sup.png';
                  break;
                case 2:
                  flagStatus = 'abnormal';
                  flagImg = '../custom/images/down-arrow1.png';
                  break;
                default:
                  break;
              }
              switch (res.sysFlag) {
                case 0:
                  flagStatus2 = '';
                  flagImg2 = '';
                  break;
                case 1:
                  flagStatus2 = 'abnormal';
                  flagImg2 = '../custom/images/sup.png';
                  break;
                case 2:
                  flagStatus2 = 'abnormal';
                  flagImg2 = '../custom/images/down-arrow1.png';
                  break;
                default:
                  break;
              }
              if(indexItem === 0){
                abnormalHtml += '<span class='+ flagItem +'>'+ res.detectTime +'&nbsp;&nbsp;'+ res.detectHour +'&nbsp;&nbsp;<em class='+ flagStatus +'>'+ res.diaValue +'<img src='+ flagImg +'></em>/<em class='+ flagStatus2 +'>'+ res.sysValue +'<img src='+ flagImg2 +'></em>&nbsp;&nbsp;mmHg</span><br>';
              }else{
                abnormalHtml2 += '<span>'+ res.detectTime +'&nbsp;&nbsp;'+ res.detectHour +'&nbsp;&nbsp;<em class='+ flagStatus +'>'+ res.diaValue +'<img src='+ flagImg +'></em>/<em class='+ flagStatus2 +'>'+ res.sysValue +'<img src='+ flagImg2 +'></em>&nbsp;&nbsp;mmHg</span><br>';
              }
              indexItem++;
            });

            html += temp.format(data.abnormalType, abnormalHtml, data.dealTime, data.docName, data.hospitalName, data.dealContent, abnormalHtml2);
            // html += temp.format(data.interven_type, abnormalHtml, data.intervene_time, data.doctor_name, data.hospital_name, data.doctor_suggest, abnormalHtml2);
          }) : '';
          $('.newadviceList').html(html);

          //点击显示隐藏异常数据
          $('.item').bind('click', function () {
            if ($(this).next().next().css('display') === 'inline') {
              $(this).next().next().hide();
              $(this).parent().removeClass();
            }else{
              $(this).next().next().show();
              $(this).parent().addClass('showItem');
            }
          });
        }
      }).fail(function (err) {
        hideMyloading();
        console.log(err);
      });
    }

    //下拉刷新
    adviceData.dataList.pullToRefresh().on('pull-to-refresh', function () {
      html = '';
      adviceData.page = 1;
      indexDoctorAdvice(adviceData.page);
      adviceData.dataList.pullToRefreshDone();
    });

    //上拉分页加载
    adviceData.dataList.infinite(100).on("infinite", function () {
      if (adviceData.moreData) {
        if (adviceData.loading) return;
        adviceData.loading = true;
        $('.weui-loadmore').show();
        indexDoctorAdvice(++adviceData.page);
      }
    });
  })
</script>
</body>
</html>
